# GNOME 日本語入力環境の強制最適化だにゃ

UbuntuをはじめとするGNOMEデスクトップ環境において、再起動やアップデートをきっかけに「日本語入力ソースが消える」「キーボードがUS配列（英語）として認識される」といった不具合を、コマンドラインから一括で修正・固定するためのドキュメントだにゃ。

---

## 1. 入力ソースと配列の強制固定

Linuxシステムでは、GUI上の設定と内部データベース（dconf）の同期が崩れることがあるにゃ。以下のプロセスで、入力システムを正しい状態へ強制的に上書きするにゃ。

### ① 入力ソースの限定

日本語入力(Mozc)と、標準の日本語キーボード(xkb)の2種類だけを登録するにゃ。これにより、意図しない「英語配列」の混入を物理的に排除するにゃ。

```bash
gsettings set org.gnome.desktop.input-sources sources "[('ibus','mozc-jp'),('xkb','jp')]"

```

### ② キーボードモデルの指定

接続されているキーボードを「日本語106キーボード」として明示的に定義するにゃ。これを指定しないと、記号（`@` や `"`）の位置がズレる原因になるにゃ。

```bash
gsettings set org.gnome.desktop.input-sources xkb-model 'jp106'

```

---

## 2. 設定のクリーンアップと反映

古い設定やカスタマイズが干渉している場合があるため、一度リセットをかけてからシステムに再認識させる必要があるにゃ。

### ③ 拡張オプションのリセット

過去に設定したキーの入れ替え（Caps Lockの変更など）や、不要なxkbオプションをすべて初期化するにゃ。

```bash
gsettings reset org.gnome.desktop.input-sources xkb-options

```

### ④ サービスの再起動

設定を即時反映させるため、インプットメソッド・フレームワーク（IBus）を再起動するにゃ。

```bash
ibus restart

```

---

## 3. 運用上の注意点だにゃ

* **反映のタイミング**: `ibus restart` で反映されない場合は、一度 **ログアウトしてから再ログイン** することで、GNOMEシェルが新しい設定を完全に読み込むにゃ。
* **Mozcの前提条件**: このスクリプトは `ibus-mozc` がインストールされていることを前提としているにゃ。もし入っていなければ、先に `sudo apt install ibus-mozc` を叩くんだにゃ。
* **system層への保存**: この設定はハードウェアに近い挙動を制御するものだから、ディレクトリ構成としては `system/keyboard/` にスクリプトとして配置するのが適切だにゃ。
